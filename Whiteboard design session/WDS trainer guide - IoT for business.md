![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/master/Media/ms-cloud-workshop.png "Microsoft Cloud Workshops")


<div class="MCWHeader1">
IoT for business
</div>

<div class="MCWHeader2">
Whiteboard design session trainer guide
</div>

<div class="MCWHeader3">
April 2018
</div>


Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

© 2018 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.

**Contents**

<!-- TOC -->

- [Trainer information](#trainer-information)
    - [Role of the trainer](#role-of-the-trainer)
    - [Whiteboard design session flow](#whiteboard-design-session-flow)
    - [Before the whiteboard design session: how to prepare](#before-the-whiteboard-design-session-how-to-prepare)
    - [During the whiteboard design session: tips for an effective whiteboard design session](#during-the-whiteboard-design-session-tips-for-an-effective-whiteboard-design-session)
- [IoT for business whiteboard design session student guide](#iot-for-business-whiteboard-design-session-student-guide)
    - [Abstract and learning objectives](#abstract-and-learning-objectives)
    - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study)
        - [Customer situation](#customer-situation)
        - [Customer needs](#customer-needs)
        - [Customer objections](#customer-objections)
        - [Infographic for common scenarios](#infographic-for-common-scenarios)
    - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution)
    - [Step 3: Present the solution](#step-3-present-the-solution)
    - [Step 3: Present the solution](#step-3-present-the-solution-1)
    - [Wrap-up](#wrap-up)
    - [Additional references](#additional-references)
- [IoT for business whiteboard design session trainer guide](#iot-for-business-whiteboard-design-session-trainer-guide)
    - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study-1)
    - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution-1)
    - [Step 3: Present the solution](#step-3-present-the-solution-2)
    - [Wrap-up](#wrap-up-1)
    - [Preferred target audience](#preferred-target-audience)
    - [Preferred solution](#preferred-solution)
    - [Checklist of preferred objection handling](#checklist-of-preferred-objection-handling)
    - [Customer quote (to be read back to the attendees at the end)](#customer-quote-to-be-read-back-to-the-attendees-at-the-end)

<!-- /TOC -->

# Trainer information

Thank you for taking time to support the whiteboard design sessions as a trainer!

## Role of the trainer

An amazing trainer:

-   Creates a safe environment in which learning can take place

-   Stimulates the participant's thinking

-   Involves the participant in the learning process

-   Manages the learning process (on time, on topic, and adjusting to benefit participants)

-   Ensures individual participant accountability

-   Ties it all together for the participant

-   Provides insight and experience to the learning process

-   Effectively leads the whiteboard design session discussion

-   Monitors quality and appropriateness of participant deliverables

-   Effectively leads the feedback process

## Whiteboard design session flow 

Each whiteboard design session uses the following flow:

**Step 1: Review the customer case study (15 minutes)**

Outcome: Analyze your customer's needs.

-   Customer's background, situation, needs and technical requirements

-   Current customer infrastructure and architecture

-   Potential issues, objectives, and blockers

**Step 2: Design a proof of concept solution (60 minutes)**

Outcome: Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

-   Determine your target customer audience

-   Determine customer's business needs to address your solution

-   Design and diagram your solution

-   Prepare to present your solution

**Step 3: Present the solution (30 minutes)**

Outcome: Present solution to your customer.

-   Present solution

-   Respond to customer objections

-   Receive feedback

**Wrap-up (15 minutes)**

-   Review preferred solution

## Before the whiteboard design session: How to prepare

Before conducting your first whiteboard design session:

-   Read the Attendee guide (including the case study) and Trainer guide

-   Become familiar with all key points and activities

-   Plan the point you want to stress, which questions you want to drive, transitions, and be ready to answer questions

-   Prior to the whiteboard design session, discuss the case study to pick up more ideas

-   Make notes for later

## During the whiteboard design session: tips for an effective whiteboard design session

**Refer to the Trainer Guide** to stay on track and observe the timings.

**Do not expect to memorize every detail** of the whiteboard design session.

When participants are doing activities, you can **look ahead to refresh your memory**.

-   **Adjust activity and whiteboard design session pace** as needed to allow time for presenting, feedback, and sharing

-   **Add examples, points, and stories** from your own experience. Think about stories you can share that help you make your points clearly and effectively.

-   **Consider creating a "parking lot"** to record issues or questions raised that are outside the scope of the whiteboard design session or can be answered later. Decide how you will address these issues, so you can acknowledge them without being derailed by them.

***Have fun**! Encourage participants to have fun and share!*

**Involve your participants.** Talk and share your knowledge but always involve your participants, even while you are the one speaking.

**Ask questions** and get them to share to fully involve your group in the learning process.

**Ask first** whenever possible. Before launching into a topic, learn your audience's opinions about it and experiences with it. Asking first enables you to assess their level of knowledge and experience and leaves them more open to what you are presenting.

**Wait for responses**. If you ask a question such as, "What's your experience with (fill in the blank)?" Wait. Do not be afraid of a little silence. If you leap into the silence, your participants will feel you are not serious about involving them and will become passive. Give participants a chance to think, and if no one answers, patiently ask again. You will usually get a response.

#  IoT for business whiteboard design session student guide

## Abstract and learning objectives 

Use the unique benefits of Internet of Things (IoT) to build a smart city solution to help improve traffic and public transportation in New York City. Use a combination of the power of the cloud, along with IoT Edge devices to provide predictive maintenance of city buses, including machine learning for anomaly detection, location broadcasting to update bus route status, and to send traffic information to help inform the timing of traffic lights. Traffic lights will also receive new IoT devices that can help detect maintenance and performance issues, such as when a bulb is out. Easily view all of this information through a centralized reporting dashboard provided by Azure Time Series Insights.

Learning objectives:

-   Use Azure IoT Edge to collect vehicle telemetry data, detect anomalies with the help of a local Azure Machine Learning model, and send the summarized data to Azure IoT Hub as needed

-   Use IoT Hub to manage IoT devices

-   Use Azure Time Series Insights to store, visualize, and query the large amounts of time series data generated by various IoT devices, as well as conduct root-cause analysis and anomaly detection

-   Build a customer application on top of Time Series Insights, using its available REST Query APIs

-   Use Azure Location Based Services to visualize bus location data on a map

## Step 1: Review the customer case study 

**Outcome** 

Analyze your customer’s needs.

Timeframe: 15 minutes 

Directions: With all participants in the session, the facilitator/SME presents an overview of the customer case study along with technical tips. 
1.  Meet your table participants and trainer 
2.  Read all of the directions for steps 1–3 in the student guide 
3.  As a table team, review the following customer case study

### Customer situation

New York City council has conducted a six-month study of new and emerging technologies that can improve the lives of its citizens. Being the largest city in the US, the challenges most cities face are compounded by scale. Many of these challenges revolve around city traffic and public transportation.

At the conclusion of their study, the city council realized that the Internet of Things (IoT) is widely available and are becoming more integrated into our daily lives. NYC can capitalize on the wide availability and affordability of IoT devices. This means physical things like traffic lights and vehicles will be able to collect and share data by connecting to the Internet. Through analytics, cities can turn this data into intelligent information that will change the way the world works.

They realize that IoT offers cities revolutionary ways to gather this vital data. Analyzing this information to understand how a city operates will improve response times for everyday purposes and acute emergencies. This wave of change will enable innovation, new services, and cost savings. However, if NYC is going to be \"smart\" (that is, IoT-connected), it needs to devise a strategy for deploying technologies rather than allowing 1,000 ad-hoc systems to take root without forethought. A proactive strategy will maximize the return on an IoT investment.

New York City buses are widely used throughout the many boroughs, such as Manhattan, Brooklyn, and the Bronx. It would make sense to somehow attach IoT devices to those buses to perform a number of functions such as preventive maintenance and tracking driver performance. It would be great if only the most important information is sent off over the internet instead of constantly sending a lot of data over expensive cellular connectivity. The most important information could be described as anomalies, like impending mechanical breakdowns or reckless driving. The buses will periodically send their location information that can be used to track their progress on their route. All of the information can be uploaded once the bus arrives at its home station where it has Wi-Fi connectivity. The full data could then be used for accounting and analysis of the data collected throughout the day.

Because these buses are so prevalent on all the major roads, they should be able to act as traffic bellwethers, using that information along with their location to inform the timing of traffic lights. These traffic lights contain control boxes that can be remotely controlled.

NYC city council would also like to increase the intelligence of the traffic lights and reduce physical inspections by adding IoT devices with sensors that can detect maintenance and performance issues, such as when a bulb is out, if the light sequence is stuck in a continuous cycle loop outside of normal parameters, voltage irregularities, etc. Unlike the city buses, these traffic lights are always connected to the internet and can send and receive command and control information as often as needed.

Relecloud has been contracted to build a cloud-based architecture based on these requirements. They have researched IoT-related service offerings from various cloud providers and are interested in recent capabilities added to Azure for storing and evaluating time series data, as well as building IoT devices that run on the edge for localized data transformation and processing.

"While bidding for the NYC smart city contract, we made it a primary goal from the start to build a solution that can easily be taken over by the city's IT department," says Rodrigo Romani, CTO of Relecloud. "Localizing telemetry captured on buses, that can be evaluated on the fly, while at the same time controlling the flow of data over a slow or unreliable internet connection seems like a tall order. We need a solution that is repeatable for fleets of buses entering or leaving service and is manageable in a way that makes it easy to send out targeted updates to groups of buses at a time."

Following this same mandate of ease of use and future flexibility without overtaxing an already busy city IT department, Relecloud is seeking options for capturing and displaying time series data that allows the end user to easily combine all of the data in any number of ways, with advanced querying and filtering options, and that can automatically handle schema changes of incoming telemetry and new device types as they are added. Additionally, this data needs to be accessible by an external web application for managing alerts and device management and must be able to display the raw data within a given timeframe, without pre-aggregation, at scale.

### Customer needs 

1.  Reduce bus maintenance costs by analyzing city bus telemetry and applying predictive analysis provided by a trained machine learning model

2.  Detect other anomalies, such as bus driver behavior, that can be sent as needed

3.  Reduce the amount of information transmitted to the cloud by buses, which use expensive cellular data

4.  Store the bus telemetry data locally when offline and send when internet connectivity is available

5.  Send regular location updates of city buses that can be used to display on a map, update bus routes, and track traffic conditions

6.  Use the traffic information from the buses to help inform the timing of traffic lights

7.  Install IoT devices on traffic lights for maintenance purposes

8.  Easily combine all of the time series data in a single pane of view, with advanced querying and filtering options, and that can automatically handle schema changes of incoming telemetry and new device types as they are added.

9.  Have a custom web application to view the buses and traffic lights on a map, manage device provisioning, alert rules, reference data, and control messages

### Customer objections 

1.  If bus data is collected offline and sent later on, how can we be certain that the time series data is not displayed out of order from when it was captured?

2.  We would like to be able to have more than one service access the IoT data without leading to reuse by multiple readers, and other negative effects. Is this possible?

3.  We are concerned about rolling out updates to all edge devices at once, in case there's a problem. Can we deploy updates to small groups instead?


### Infographic for common scenarios

![A Common Scenario of Internet of Things flowchart is split between Azure and On-Premises. At a high leve, Azure steps are: Ingest, Stream Processing, Batch Storage, Speed Serving, Batch Processing, Batch View Serving, and Analytics Clients.](images/Whiteboarddesignsessiontrainerguide-IoTforbusinessimages/media/image2.png "Common Scenario for IoT")


## Step 2: Design a proof of concept solution

**Outcome** 

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format. 

Timeframe: 60 minutes

**Business needs**

Directions: With all participants at your table, answer the following questions and list the answers on a flip chart. 
1.  Who should you present this solution to? Who is your target customer audience? Who are the decision makers? 
2.  What customer business needs do you need to address with your solution?

**Design** 

Directions: With all participants at your table, respond to the following questions on a flip chart.

 *High-level architecture*

1.  Without getting into the details (the following sections will address the particular details), diagram your initial vision for handling the top-level requirements for the bus and traffic light IoT devices, data ingestion, storage, and visualization.

*IoT Devices*

1.  Which data ingest service would you use for this scenario, IoT Hub or Event Hubs? Be specific

2.  How will you process the vehicle telemetry data locally to only send important data about driver performance or potential mechanical issues while the bus is in transit, with limited data connectivity?

3.  What would you recommend using to separately send bus location and speed data at regular intervals?

4.  Describe how you would send traffic light telemetry, and in turn, have the traffic lights receive commands to update their timing

5.  Using your ingest service, how would you handle critical messages separately to route them to custom endpoints based on message properties?

*Data and visualization*

1.  Keeping the requirement for ease of use and flexibility in mind, how would you propose storing time series data for all the IoT devices? Is there a need for secondary storage?

2.  How will you allow end users to visualize the large amount of data in one place, which is flexible enough to handle changing data schemas and allow for ad-hoc queries and sharing views between users?

3.  Describe how the custom web application will be hosted, as well as how it will access the stored telemetry including displaying location information on a map, manage reference data (speed limit information, speed alert thresholds, vehicle information, etc.), alerts, and device control messages. Also, describe how you will use it to provision new IoT devices and send manual cloud-to-device messages.

4.  What would you recommend using to combine bus and traffic light information, filtering the data by the close proximity of both types of IoT devices, then by average bus speed information based on predefined speed thresholds for detecting slow traffic near the traffic lights? How can this data be used to send alerts and cloud-to-device traffic light timing change messages?

*Location-based data and mapping*

1.  Relecloud wants to integrate map visualization to show the location of buses, traffic lights, and other devices. They would like to use a mapping service that does not require them to send data to an external resource, can be used with other Azure services like Stream Analytics, and supports data privacy and compliance when needed.

2.  How would you perform reverse geocode queries to find addresses and cross streets based on latitude/longitude? They would also like to view the posted speed limit and road use, such as local road use, limited access, etc.

**Prepare**

Directions: With all participants at your table: 

1.  Identify any customer needs that are not addressed with the proposed solution
2.  Identify the benefits of your solution
3.  Determine how you will respond to the customer’s objections

Prepare a 15-minute chalk-talk style presentation to the customer. 

## Step 3: Present the solution

**Outcome**

Present a solution to the target customer audience in a 15-minute chalk-talk format.

## Step 3: Present the solution

**Outcome**
 
Present a solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 30 minutes

**Presentation** 

Directions:
1.  Pair with another table
2.  One table is the Microsoft team and the other table is the customer
3.  The Microsoft team presents their proposed solution to the customer
4.  The customer makes one of the objections from the list of objections
5.  The Microsoft team responds to the objection
6.  The customer team gives feedback to the Microsoft team
7.  Tables switch roles and repeat Steps 2–6

##  Wrap-up 

Timeframe: 15 minutes

Directions: Tables reconvene with the larger group to hear the facilitator/SME share the preferred solution for the case study.

##  Additional references

|    |            |
|----------|:-------------:|
| Hi-resolution version of blueprint                                       | > <https://msdn.microsoft.com/dn630664#fbid=rVymR_3WSRo>                                        |
| What is Azure IoT Edge?                                                  | > <https://docs.microsoft.com/en-us/azure/iot-edge/how-iot-edge-works>                          |
| Understand the requirements and tools for developing IoT Edge modules    | > <https://docs.microsoft.com/en-us/azure/iot-edge/module-development>                          |
| Deploy Azure Machine Learning as an IoT Edge module                      | <https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-deploy-machine-learning>              |
| Deploy and monitor IoT Edge modules at scale                             | <https://docs.microsoft.com/en-us/azure/iot-edge/how-to-deploy-monitor>                         |
| Understand and use device twins in IoT Hub                               | <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-device-twins>                  |
| Routing messages with IoT Hub                                            | <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-csharp-csharp-process-d2c>              |
| Use message routes and custom endpoints for device-to-cloud messages     | <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-read-custom>          |
| Send cloud-to-device messages from IoT Hub                               | <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-c2d>                  |
| Schedule jobs on multiple devices                                        | <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-jobs>                          |
| What is Azure Time Series Insights?                                      | <https://docs.microsoft.com/en-us/azure/time-series-insights/time-series-insights-overview>     |
| Azure Time Series Insights explorer                                      | <https://docs.microsoft.com/en-us/azure/time-series-insights/time-series-insights-explorer>     |
| About Azure Cosmos DB                                                    | <https://docs.microsoft.com/en-us/azure/cosmos-db/introduction>                                 |
| Target Azure Cosmos DB for JSON output from Stream Analytics             | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-documentdb-output>    |
| Using reference data or lookup tables in a Stream Analytics input stream | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-use-reference-data>   |
| Run Azure Functions with Azure Stream Analytics jobs                     | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-with-azure-functions> |
| Azure Stream Analytics on IoT Edge                     | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-edge>                |
| GeoSpatial Functions                                   | <https://msdn.microsoft.com/en-us/library/mt778980.aspx>                                       |
| About Azure Location Based Services                    | <https://docs.microsoft.com/en-us/azure/location-based-services/about-location-based-services> |
| Using the Azure Location Based Services Search service | <https://docs.microsoft.com/en-us/azure/location-based-services/how-to-search-for-address>     |

# IoT for business whiteboard design session trainer guide

## Step 1: Review the customer case study

-   Check in with your table participants to introduce yourself as the trainer

-   Ask, "What questions do you have about the customer case study?"

-   Briefly review the steps and timeframes of the whiteboard design session

-   Ready, set, go! Let the table participants begin.

## Step 2: Design a proof of concept solution

-   Check in with your tables to ensure that they are transitioning from step to step on time

-   Provide some feedback on their responses to the business needs and design

    -   Try asking questions first that will lead the participants to discover the answers on their own

-   Provide feedback for their responses to the customer's objections

    -   Try asking questions first that will lead the participants to discover the answers on their own

## Step 3: Present the solution

-   Determine which table will be paired with your table before Step 3 begins

-   For the first round, assign one table as the presenting team and the other table as the customer

-   Have the presenting team present their solution to the customer team

    -   Have the customer team provide one objection for the presenting team to respond to

    -   The presentation, objections, and feedback should take no longer than 15 minutes

    -   If needed, the trainer may also provide feedback

## Wrap-up

-   Have the table participants reconvene with the larger session group to hear the facilitator/SME share the following preferred solution

##  Preferred target audience

Rodrigo Romani, Chief Technical Officer (CTO), Relecloud

The primary audience is the business decision makers and technology decision makers. From the case study scenario, this includes Rodrigo Romani, CTO of Relecloud. Usually we talk to the infrastructure managers who report to the chief information officers (CIOs), or to application sponsors (like a vice president \[VP\] line of business \[LOB\], or chief marketing officer \[CMO\]), or to those who represent the business unit IT or developers that report to application sponsors.

## Preferred solution

*High-level architecture*

1.  Without getting into the details (the following sections will address the particular details), diagram your initial vision for handling the top-level requirements for the license plate processing serverless components, OCR capabilities, data export workflow, and monitoring plus DevOps.

    ![The Solution Architecture diagram is described in the text following the diagram.](images/Whiteboarddesignsessiontrainerguide-IoTforbusinessimages/media/image3.png "Solution Architecture diagram")

    The solution begins with an IoT Edge Device installed on each city bus, which is responsible for reading the vehicle telemetry from the bus, such as speed, fuel level, oil level, engine temperature, etc. A trained Azure Machine Learning predictive maintenance module is loaded on the IoT Edge device to detect anomalies and potential issues. An Azure Stream Analytics module is added to the IoT Edge device to filter the output of the predictive maintenance module and send only the anomaly data to IoT Hub. A GPS IoT Device is separately added to the bus to periodically send location and speed data to IoT Hub. An IoT device is added to various traffic lights to send maintenance-related telemetry, such as voltage readings and whether a light is no longer functional. It is registered as a device in IoT Hub, including properties such as its longitude and latitude and serial number. It can receive cloud-to-device messages through IoT Hub, allowing upstream services to send updates like the timing of its lights based on traffic congestion information. An additional consumer group is added to IoT Hub's messages/events endpoint, allowing a Time Series Insights instance and a Stream Analytics instance to simultaneously read the incoming data. Time Series Insights is used to store the raw time series data and provides advanced filtering, custom ad-hoc queries, and visualizations that can overlay data from several classes of IoT devices. Stream Analytics is used to collect the bus GPS and traffic light data, joining the two using geospatial queries to find buses within close proximity to traffic lights, and using reference data to filter the data based on average bus speeds. The filtered data indicating traffic congestion is sent to Azure Functions to evaluate the data and compare it against traffic data stored in Cosmos DB. If it appears traffic congestion is changing, the function updates Cosmos DB accordingly. Another function is triggered when traffic timing control messages appear in a Cosmos DB collection, whether automatically added by the previous function, or manually added by the web app. It sends a cloud-to-device control message to IoT Hub to send a timing change request to a specific traffic light if needed. Stream Analytics also inserts unfiltered bus location data to Cosmos DB. A custom-built web app uses the Time Series Insights REST Query APIs to display a custom view of the captured IoT data. It uses Azure Location Based Services to plot the devices on a map and display geocode data such as posted speed limits and road use. The web app connects to Cosmos DB to manage alert rules and device control messages. It is also used to provision new IoT devices and send manual cloud-to-device messages through IoT Hub. At the bottom of the diagram is the Stream Analytics reference data update process, orchestrated by Azure Data Factory. The reference data stores speed limit information and speed alert threshold data for the traffic lights.

> NOTE: The preferred solution is only one of many possible, viable approaches.

*IoT Devices*

1.  Which data ingest service would you use for this scenario, IoT Hub or Event Hubs? Be specific.

    Use IoT Hub to manage the devices and ingest all data. Unlike Event Hubs, it enables two-way communication between Azure and the devices, allowing the customer to send control data back to devices as needed, as well as remotely managing firmware updates. In addition, IoT Hub enables you to use and manage IoT Edge devices, which will be used on the buses.

2.  How will you process the vehicle telemetry data locally to only send important data about driver performance or potential mechanical issues while the bus is in transit, with limited data connectivity?

    Azure IoT Edge can be used to shift the data analytics responsibility from the cloud to each bus, and only send that data up to Azure when an anomaly is detected. This helps dramatically cut down on the amount of data that needs to be sent out, meeting their requirement for minimizing cellular data usage. Create an IoT Edge Device with a custom module to ingest the vehicle telemetry. Use Azure Machine Learning to train a model that evaluates the vehicle telemetry and conducts predictive analysis to detect mechanical issues and driver performance. Load the trained model to the IoT Edge device to detect anomalies locally. Add a Stream Analytics module that filters the output of the machine learning module and send only the anomaly data to IoT Hub. Routes are used to allow modules to send data to each other, then send the final filtered data upstream to IoT Hub. All data is stored locally while offline and can be sent when internet connectivity is available.

3.  What would you recommend using to separately send bus location and speed data at regular intervals?

    A GPS-enabled IoT device can be added to the bus that regularly sends bus location and speed data through IoT Hub. This data will be used to update bus route information and track average speeds in proximity to traffic lights also containing IoT devices.

4.  Describe how you would send traffic light telemetry, and in turn, have the traffic lights receive commands to update their timing.

    Traffic lights will have IoT devices installed that send maintenance-related telemetry, such as voltage readings, state (which light is currently illuminated), bulb status, etc. When the IoT device is provisioned in IoT Hub, its device twin will contain metadata properties for the serial number, latitude, longitude, and street information. The custom web application will populate this data and handle device provisioning for this and other IoT devices. The device will update its reported properties for its maintenance and state telemetry through device-to-cloud messages. One-way notifications can be sent to the device via cloud-to-device messages sent through IoT Hub that can be used to modify the light timing (how long a light stays green or red). In addition, the back-end service that sends the cloud-to-device message can request feedback from the device, letting it know whether the command was successfully processed. This allows the sender to implement retry or compensation logic.

5.  Using your ingest service, how would you handle critical messages separately to route them to custom endpoints based on message properties? 

    Use custom endpoints and routes in IoT Hub to route device-to-cloud messages to a service-facing endpoint such as a Service Bus Queue, based on the message property. This will make sure critical messages, such as a traffic light outage or mechanical failure on a bus, to be processed separately if needed. This is accomplished by creating a new Service Bus Queue in the same subscription and region as IoT Hub, then creating a custom endpoint in IoT Hub that for the queue. Create a new route using DeviceMessages as its data source, the custom endpoint you created for the route endpoint, and a query parameter that filters on a device property, such as: level="critical". Device messages flowing into IoT Hub that meet the new routing rule will be sent to your Service Bus Queue, where any downstream services or applications can act upon the message data.

*Data and visualization*

1.  Keeping the requirement for ease of use and flexibility in mind, how would you propose storing time series data for all the IoT devices? Is there need for secondary storage?

    Use Azure Time Series Insights to store, visualize, and query the large amounts of time series data generated by the edge and traffic light IoT devices, as well as conduct root-cause analysis and anomaly detection. It easily connects to IoT Hub and automatically parsons JSON from messages and joins metadata with telemetry and indexes your data in a columnar store. This data is stored long-term, and you can interactively query billions of events in seconds. Time series data is defined by data that has a timestamp, and time is most meaningful as an axis. Because we are tracking buses, traffic lights, and potentially other smart devices that have the potential of interacting with one another, being able to view this related information side-by-side or over top of one another is useful for correlating events that occur at the same time. Time Series Insights has tools like patterns and perspective views to conduct and save multi-step root-cause analysis. Further, Time Series Insights works in conjunction with alerting services like Azure Stream Analytics, so alerts and detected anomalies can be viewed in near real-time in the Time Series Insights explorer. As for secondary storage, yes, a data store such as Cosmos DB can be used to store data that relates to incoming device telemetry that is stored in Time Series Insights. This includes alert information that is generated when maintenance issues occur, and alert settings for specifying alert thresholds such as average bus speed ranges in proximity to traffic lights that could indicated congestion requiring traffic light timing updates. Additionally, bus location data can be ingested into Cosmos DB to be used as a reference when comparing current speed and location information to help detect traffic congestion, as well as to update bus route data. This database can also be used to help manage IoT devices, store data that is used when rolling out firmware updates, etc.

2.  How will you allow end users to visualize the large amount of data in one place, which is flexible enough to handle changing data schemas and allow for ad-hoc queries and sharing views between users?

    Time Series Insights (TSI) provides high-performance visualizations out of the box to help users overlay device telemetry as well as associated events from alerting services like Stream Analytics. Use its perspective view to quickly clone, modify existing visualizations, and add additional ones in a quad-chart view. All visualizations can be saved and shared with other users in your organization. The flexible query and filtering interface helps users rapidly adapt to changing schemas and new device types. There is no need to construct custom forms that contain fields for device-specific schemas, as all of this is dynamically handled by the Time Series Insights interface. TSI makes it easy to view the raw message data for any given timeframe and device.

3.  Describe how the custom web application will be hosted, as well as how it will access the stored telemetry including displaying location information on a map, manage reference data (speed limit information, speed alert thresholds, vehicle information, etc.), alerts, and device control messages. Also, describe how you will use it to provision new IoT devices and send manual cloud-to-device messages.

    Host the web application in the Web Apps PaaS service. Alternatively, host it within a series of Docker containers in a microservices architecture for maximum scalability if needed. The custom web application can use Time Series Insights as its back-end service for indexing, storing, and aggregating time series data. This is where any custom visualizations, such as dynamic maps can be built and served to display the data. This is accomplished through Time Series Insight's Query APIs. It will connect to Cosmos DB, the secondary data store in this scenario, to access and store reference data. Build custom forms in the web app to manage this data, as well as alert thresholds and device control message schema information that will be used to either manually send cloud-to-device messages from the web app, or automatically from another service such as Azure Functions. Use the IoT Service SDK to simplify device management. When creating a new device using the SDK's device registry manager, add a new device twin containing custom tags or properties. The service SDK is available for .NET, Java, Node.js, Python, and C. This SDK can also be used to send cloud-to-device messages. The IoT device SDK is used for sending direct messages to the device. It doesn't matter whether the sender is using the same language SDK (.NET, Node.js, etc.) as the client. The IoT service SDK can also be used to send firmware updates to the devices and track the status. If you need to broadcast jobs, such as updating device properties or tags, or invoking direct methods on multiple (potentially millions) of devices, use the IoT service SDK to create a device twin query that selects the affected devices, then broadcast the job to those devices and track progress.

4.  What would you recommend using to combine bus and traffic light information, filtering the data by close proximity of both types of IoT devices, then by average bus speed information based on predefined speed thresholds for detecting slow traffic near the traffic lights? How can this data be used to send alerts and cloud-to-device traffic light timing change messages?

    Use Azure Stream Analytics, which will allow you to run SQL-like queries against incoming telemetry data at incredible speeds to combine and filter the data at scale. The first step is to create a new consumer group to IoT Hub's messages/events endpoint, allowing the Time Series Insights instance and Stream Analytics instance to simultaneously read the incoming data. Create a new Stream Analytics input that points to the consumer group. Another input should be added that is used for reference data for bus speed-based alerts in proximity to the traffic lights. This reference data should be stored in Blob storage in CSV, JSON, or Avro format. Create an Azure Data Factory pipeline that uses a copy activity to periodically copy the reference data from Cosmos DB and updates the file in Blob storage that Stream Analytics points to for this second input. Create a Cosmos DB Stream Analytics output for storing unfiltered bus location data, and an Azure Functions output that points to a function invoked with an HTTP trigger and uses the filtered data from Stream Analytics to determine the level of traffic congestion. Create a Stream Analytics query to collect the bus GPS and traffic light data, joining the two using geospatial queries to find buses within close proximity to traffic lights, and using the reference data input to filter the data based on average bus speeds. The filtered data indicating traffic congestion is sent to Azure Functions to evaluate the data and compare it against traffic data stored in Cosmos DB. If it appears as though traffic congestion is changing, the function updates Cosmos DB accordingly. Another function is triggered when traffic timing control messages appear in a Cosmos DB collection, whether automatically added by the previous function, or manually added by the web app. It sends a cloud-to-device control message to IoT Hub to send a timing change request to a specific traffic light if needed. Here is a sample query that can be used:

    ```
    WITH
    buses AS (
        SELECT
            stream.IoTHub.ConnectionDeviceId AS bus_device_id,
            stream.latitude AS bus_latitude,
            stream.longitude AS bus_longitude,
            stream.vin, stream.speed,
            stream.IoTHub.EnqueuedTime AS bus_enqueued_time
        FROM
            IoTHubStream stream TIMESTAMP BY stream.EventEnqueuedUtcTime
        WHERE IoTHub.ConnectionDeviceId LIKE 'Simulated.bus%'
    ),
    lights AS (
        SELECT
            stream.IoTHub.ConnectionDeviceId AS light_device_id,
            stream.timing, stream.serial_number,
            stream.latitude AS light_latitude,
            stream.longitude AS light_longitude
        FROM
            IoTHubStream AS stream TIMESTAMP BY stream.EventEnqueuedUtcTime
        WHERE IoTHub.ConnectionDeviceId LIKE 'Simulated.trafficlight%'
    )
    -- Store bus location data in Cosmos DB
    SELECT
        *
    INTO Cosmos
    FROM buses
    -- Send traffic congestion data to Azure Functions
    SELECT
        System.TimeStamp AS WindowEnd,
        buses.vin, buses.bus_latitude, buses.bus_longitude,
        buses.bus_device_id, buses.speed, lights.timing,
        lights.serial_number, lights.light_device_id,
        AVG(buses.speed) AS average_speed,
        buses.bus_enqueued_time, COUNT(*)
    INTO trafficfunction
    FROM
        buses
    JOIN lights ON
        ST_DISTANCE(
            CreatePoint(buses.bus_latitude, buses.bus_longitude),
            CreatePoint(lights.light_latitude, lights.light_longitude)
        ) < 200 -- within 200 meters
    AND DATEDIFF(minute, buses, lights) BETWEEN 0 AND 2
    JOIN
        SpeedLimitReference R ON
    lights.serial_number = R.SerialNumber
    WHERE buses.speed BETWEEN
        CAST(R.SpeedMinAlert as float) AND
        CAST(R.SpeedMaxAlert as float)
    GROUP BY buses.vin, buses.bus_latitude, buses.bus_longitude,
    buses.bus_device_id, buses.speed, lights.timing,
    lights.serial_number, lights.light_device_id,
    buses.bus_enqueued_time,
    TumblingWindow(Duration(minute, 2), Offset(millisecond, -1))


    ```

*Location-based data and mapping*

1.  Relecloud wants to integrate map visualization to show the location of buses, traffic lights, and other devices. They would like to use a mapping service that does not require them to send data to an external resource, can be used with other Azure services like Stream Analytics, and supports data privacy and compliance when needed.

    Use Azure Location Based Services (LBS), which includes service APIs for Maps, Search, Traffic, and Time Zones. This allows all of the data to stay within Azure and removes an external dependency, allowing the customer to use the same billing, account, and Azure infrastructure as all of the other services in this solution. As a first-class service, LBS supports data privacy and compliance, such as GDPR (General Data Protection Regulation).

2.  How would you perform reverse geocode queries to find addresses and cross streets based on latitude/longitude? They would also like to view the posted speed limit and road use, such as local road use, limited access, etc.

    Use the Location Based Services Search API. This can be used to perform the reverse geocode queries to display on the custom web app's UI but can also be used to update the reference information for the traffic lights, such as the posted speed limit. This data can easily be retrieved through HTTP REST requests. Here is an example JSON response using the Search API, passing in the coordinates for one of the traffic lights. Notice that it also includes speed limit and road use data:

    ```
    {
        "summary": {
            "queryTime": 16,
            "numResults": 1
        },
        "addresses": [
            {
                "address": {
                    "buildingNumber": "83",
                    "streetNumber": "83",
                    "routeNumbers": [],
                    "street": "W 47th St",
                    "streetName": "W 47th St",
                    "streetNameAndNumber": "83 W 47th St",
                    "countryCode": "US",
                    "countrySubdivision": "NY",
                    "countrySubdivisionName": "New York",
                    "municipality": "New York",
                    "postalCode": "10036",
                    "municipalitySubdivision": "Manhattan",
                    "country": "United States of America",
                    "countryCodeISO3": "USA",
                    "freeformAddress": "83 W 47th St, New York NY 10036",
                    "speedLimit": "25.00MPH",
                    "boundingBox": {
                        "northEast": "40.762460,-73.975740",
                        "southWest": "40.753460,-73.987620",
                        "entity": "position"
                    }
                },
                "position": "40.757960,-73.981680",
                "roadUse": [
                    "LocalStreet"
                ]
            }
        ]
    }

    ```

## Checklist of preferred objection handling

1.  If bus data is collected offline and sent later on, how can we be certain that the time series data is not displayed out of order from when it was captured?

    When you are collecting and storing time series data, the order of events and accurate time stamping is crucial. Use the device.msg.created value for the Time Series Insights timestamp data. This ensures that data received out of order, or sometime in the future long after the event occurred, is accurately reflected in its actual time of event.

2.  We would like to be able to have more than one service access the IoT data without leading to reuse by multiple readers, and other negative effects. Is this possible?

    Yes, this is possible by adding additional event consumers to the IoT Hub messaging endpoint. You can also add up to 10 custom endpoints used to send messages to different services based on routing rules.

3.  We are concerned about rolling out updates to all edge devices at once, in case there's a problem. Can we deploy updates to small groups instead?

    Yes, this can be accomplished by creating an IoT Edge deployment. This is a dynamic process that enables you to deploy multiple modules to multiple edge devices at once and track the status and health of the modules. Your devices need one or more tags configured in the device twin that can be used to group updates to similar devices. For instance, you might have various fleets of buses that you can identify as fleet1, fleet2, etc. All buses in fleet1 can be updated at once, in this case.

## Customer quote (to be read back to the attendees at the end)

*"We were amazed when our Microsoft rep introduced us to IoT Edge devices! We were already familiar with IoT Hub, Streaming Analytics, and Azure Machine Learning, but when we found out that some of these same components can be run on a modestly powered device on our buses through IoT Edge, we couldn't wait to get started. The best part about our new solution is that we were able to use the same powerful capabilities for working with our IoT devices both offline and in the cloud. Having ready-made services online in minutes that help us handle, and manage, a huge number of devices was just the cherry on top!"*

--- Rodrigo Romani, CTO, Relecloud

